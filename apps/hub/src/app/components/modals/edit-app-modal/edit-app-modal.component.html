<div class="sh-modal-header">
    <h5 class="sh-modal-title">{{app.id ? 'Edit App' : 'Add New App'}}</h5>
    <button type="button" class="sh-modal-close" (click)="close()">
        <span class="material-symbols-outlined">close</span>
    </button>
</div>
<div class="sh-modal-body">
    <div class="modal-layout">
        <!-- Left Column: Icon Preview -->
        <div class="icon-preview-section">
            <div class="icon-preview-card">
                <div class="icon-preview-wrapper">
                    <img *ngIf="app.icon && !iconError" [src]="app.icon" [alt]="app.name || 'App Icon'" class="icon-preview-img" (error)="iconError = true">
                    <div *ngIf="!app.icon || iconError" class="icon-preview-fallback">
                        <span class="material-symbols-outlined">inventory_2</span>
                    </div>
                </div>
                <span class="icon-preview-name">{{app.name || 'App Name'}}</span>
                <span class="icon-preview-url">{{app.url || 'https://...'}}</span>
            </div>
        </div>
        <!-- Right Column: Form -->
        <div class="form-section">
            <form (ngSubmit)="save()" #f="ngForm">
                <!-- Template Selector -->
                <div class="form-group" *ngIf="!app.id">
                    <label class="sh-label">Use Template </label>
                    <select class="sh-input sh-select" [ngModel]="selectedTemplate?.id || ''" (ngModelChange)="onTemplateSelect($event)" name="template">
                        <option value="">Custom App (No Template)</option>
                        <optgroup label="Media">
                            <option *ngFor="let t of templates | filter:'category':'media'" [value]="t.id">{{t.name}}</option>
                        </optgroup>
                        <optgroup label="Downloads">
                            <option *ngFor="let t of templates | filter:'category':'downloads'" [value]="t.id">{{t.name}}</option>
                        </optgroup>
                        <optgroup label="Infrastructure">
                            <option *ngFor="let t of templates | filter:'category':'infrastructure'" [value]="t.id">{{t.name}}</option>
                        </optgroup>
                        <optgroup label="Productivity">
                            <option *ngFor="let t of templates | filter:'category':'productivity'" [value]="t.id">{{t.name}}</option>
                        </optgroup>
                    </select>
                </div>
                <!-- Basic Info -->
                <div class="form-group">
                    <label class="sh-label">Name</label>
                    <input type="text" class="sh-input" [(ngModel)]="app.name" name="name" placeholder="My App" required>
                </div>
                <div class="form-group">
                    <label class="sh-label">URL</label>
                    <input type="url" class="sh-input" [(ngModel)]="app.url" name="url" placeholder="https://example.com" required>
                </div>
                <!-- Type Selection -->
                <div class="form-group">
                    <label class="sh-label">Type</label>
                    <div class="sh-btn-group-toggle">
                        <button type="button" class="sh-toggle-btn" [class.active]="appType === 'app'" (click)="appType = 'app'">
                            <span class="material-symbols-outlined">grid_view</span> Standard App </button>
                        <button type="button" class="sh-toggle-btn" [class.active]="appType === 'bookmark'" (click)="appType = 'bookmark'">
                            <span class="material-symbols-outlined">bolt</span> Fast Access </button>
                    </div>
                </div>
                <!-- Section Selection -->
                <div class="form-group" *ngIf="appType === 'app'">
                    <label class="sh-label">Section</label>
                    <select class="sh-input sh-select" [(ngModel)]="app.section" name="sectionId" required>
                        <option [ngValue]="undefined" disabled>Select a section</option>
                        <option *ngFor="let section of sections" [ngValue]="section.id">{{section.title}}</option>
                    </select>
                </div>
                <!-- Health Check Toggle -->
                <div class="form-group">
                    <label class="sh-label">Status Monitoring</label>
                    <div class="health-check-toggle">
                        <label class="toggle-switch">
                            <input type="checkbox" [(ngModel)]="app.healthCheck" name="healthCheck" [ngModelOptions]="{standalone: true}">
                            <span class="toggle-slider"></span>
                        </label>
                        <span class="toggle-label">
                            <span class="material-symbols-outlined">{{app.healthCheck !== false ? 'monitor_heart' : 'cancel'}}</span> {{app.healthCheck !== false ? 'Health check enabled' : 'Health check disabled'}} </span>
                    </div>
                </div>
                <!-- Icon Selection (only show if no template, or template without icon) -->
                <div class="form-group" *ngIf="iconType !== 'template'">
                    <label class="sh-label">Icon</label>
                    <div class="sh-btn-group-toggle icon-type-toggle">
                        <button type="button" class="sh-toggle-btn" [class.active]="iconType === 'dashboard'" (click)="iconType = 'dashboard'; onIconTypeChange()">
                            <span class="material-symbols-outlined">collections_bookmark</span> Library </button>
                        <button type="button" class="sh-toggle-btn" [class.active]="iconType === 'url'" (click)="iconType = 'url'">
                            <span class="material-symbols-outlined">link</span> URL </button>
                        <button type="button" class="sh-toggle-btn" [class.active]="iconType === 'file'" (click)="iconType = 'file'">
                            <span class="material-symbols-outlined">upload</span> Upload </button>
                    </div>
                    <!-- Dashboard Icons Search -->
                    <div *ngIf="iconType === 'dashboard'" class="icon-search-section">
                        <input type="text" class="sh-input" [(ngModel)]="iconSearchQuery" (input)="onIconSearch()" placeholder="Search icons (e.g., youtube, plex, github)" name="iconSearch">
                        <div *ngIf="isLoadingIcons" class="icon-loading">
                            <div class="spinner-border spinner-border-sm"></div>
                            <span>Searching...</span>
                        </div>
                        <div *ngIf="iconSearchResults.length > 0" class="icon-grid">
                            <div *ngFor="let iconName of iconSearchResults" class="icon-item" [class.selected]="iconSearchQuery === iconName" (click)="selectDashboardIcon(iconName)" [title]="iconName">
                                <img [src]="getIconUrl(iconName)" [alt]="iconName" onerror="this.style.display='none'">
                                <small class="icon-name">{{iconName}}</small>
                            </div>
                        </div>
                        <div *ngIf="iconSearchQuery && !isLoadingIcons && iconSearchResults.length === 0" class="no-icons-msg"> No icons found. Try names like "youtube", "plex", or "github". </div>
                    </div>
                    <!-- URL Input -->
                    <div *ngIf="iconType === 'url'" class="mt-2">
                        <input type="text" class="sh-input" [(ngModel)]="app.icon" name="icon" placeholder="https://example.com/icon.png" (input)="iconError = false">
                    </div>
                    <!-- File Upload -->
                    <div *ngIf="iconType === 'file'" class="mt-2">
                        <input type="file" class="sh-input" (change)="onFileSelected($event)" accept="image/*">
                        <div *ngIf="uploading" class="upload-status">
                            <div class="spinner-border spinner-border-sm"></div>
                            <span>Uploading...</span>
                        </div>
                    </div>
                </div>
                <!-- Configuration Section (for templates with config fields) -->
                <div class="form-group config-section" *ngIf="hasConfigFields">
                    <label class="sh-label">
                        <span class="material-symbols-outlined">tune</span> {{selectedTemplate?.name}} Configuration </label>
                    <div class="config-fields">
                        <div *ngFor="let field of selectedTemplate?.configFields" class="config-field">
                            <label class="sh-label">{{field.label}}</label>
                            <input [type]="field.type" class="sh-input" [(ngModel)]="appConfig[field.key]" [name]="'config_' + field.key" [placeholder]="field.placeholder || ''" [required]="field.required || false">
                            <small *ngIf="field.description" class="config-description">{{field.description}}</small>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
<div class="sh-modal-footer">
    <button *ngIf="app.id" type="button" class="sh-btn sh-btn-danger" (click)="onDelete()">Delete</button>
    <button type="button" class="sh-btn sh-btn-secondary" (click)="close()">Cancel</button>
    <button type="button" class="sh-btn sh-btn-primary" (click)="save()" [disabled]="!app.name || !app.url || uploading">Save</button>
</div>