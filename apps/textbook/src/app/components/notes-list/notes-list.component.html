<div class="notes-container">
    <!-- Take a Note Input Bar -->
    <div class="take-note-wrapper">
        <div class="take-note-bar" (click)="openCreateModal()">
            <span class="placeholder-text">Take a note...</span>
            <div class="bar-actions">
                <button class="btn-icon" title="Manage Labels" (click)="$event.stopPropagation(); openLabelManager()">
                    <span class="material-symbols-outlined">label</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Notes Grid -->
    <div class="notes-grid">
        <div *ngFor="let note of filteredNotes" class="note-card" (click)="openEditModal(note)">
            <!-- Image Preview - Just show count with icon -->
            <div *ngIf="note.images && note.images.length > 0" class="note-image-indicator">
                <span class="material-symbols-outlined">image</span>
                <span class="image-count">{{ note.images.length }}</span>
            </div>

            <h3 class="note-title">{{ note.title || 'Untitled' }}</h3>
            
            <!-- Text Note Preview -->
            <p *ngIf="note.note_type === 'text' || !note.note_type" class="note-preview">
                {{ note.content }}
            </p>

            <!-- Todo Note Preview -->
            <div *ngIf="note.note_type === 'todo' && note.todo_items" class="todo-preview">
                <div *ngFor="let item of note.todo_items.slice(0, 3)" class="todo-preview-item">
                    <span class="material-symbols-outlined checkbox-icon" [class.checked]="item.completed">
                        {{ item.completed ? 'check_box' : 'check_box_outline_blank' }}
                    </span>
                    <span [class.completed]="item.completed">{{ item.text }}</span>
                </div>
                <div *ngIf="note.todo_items.length > 3" class="todo-more">
                    +{{ note.todo_items.length - 3 }} more
                </div>
                <div *ngIf="note.todo_items.length > 0" class="todo-progress-small">
                    <div class="progress-bar-mini">
                        <div class="progress-fill-mini" [style.width.%]="getTodoProgress(note)"></div>
                    </div>
                    <span class="progress-text-mini">
                        {{ getTodoCompletedCount(note) }}/{{ note.todo_items.length }}
                    </span>
                </div>
            </div>

            <!-- Labels -->
            <div *ngIf="note.expand?.label" class="note-labels">
                <span class="label-chip" [style.background]="getLabelColor(note) + '20'" 
                      [style.color]="getLabelColor(note)" 
                      [style.border-color]="getLabelColor(note)">
                    {{ getLabelName(note) }}
                </span>
            </div>

            <!-- Actions -->
            <div class="note-actions">
                <button class="btn-icon pin-btn" 
                        [class.active]="note.is_favorite" 
                        (click)="$event.stopPropagation(); togglePin(note)">
                    <span class="material-symbols-outlined icon-sm">keep</span>
                </button>
                <button class="btn-icon" (click)="$event.stopPropagation(); deleteNote(note.id)">
                    <span class="material-symbols-outlined icon-sm">delete</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit/Create Note Modal -->
<div *ngIf="showModal" class="modal-overlay">
    <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <!-- Note Type Selector -->
            <div class="note-type-tabs">
                <button class="type-tab" 
                        [class.active]="formData.note_type === 'text' || !formData.note_type"
                        (click)="formData.note_type = 'text'">
                    <span class="material-symbols-outlined">description</span>
                    Text
                </button>
                <button class="type-tab" 
                        [class.active]="formData.note_type === 'todo'"
                        (click)="formData.note_type = 'todo'">
                    <span class="material-symbols-outlined">checklist</span>
                    Todo
                </button>
            </div>

            <div class="header-right-actions">
                <!-- Label Selector with Create Option -->
                <div class="label-selector-wrapper">
                    <select class="label-select" [(ngModel)]="formData.label">
                        <option [ngValue]="undefined">No Label</option>
                        <option *ngFor="let label of labels" [value]="label.id">
                            {{ label.name }}
                        </option>
                    </select>
                    <button class="btn-add-label" 
                            title="Create Label"
                            (click)="toggleInlineLabelCreate()">
                        <span class="material-symbols-outlined">add</span>
                    </button>
                </div>

                <button class="btn-icon pin-btn" 
                        [class.active]="formData.is_favorite" 
                        (click)="formData.is_favorite = !formData.is_favorite">
                    <span class="material-symbols-outlined">keep</span>
                </button>

                <!-- Close Button -->
                <button class="btn-icon" (click)="closeModal()">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
        </div>

        <!-- Inline Label Creation (appears below header when toggled) -->
        <div *ngIf="showInlineLabelCreate" class="inline-label-create">
            <input type="text" 
                   class="inline-label-input" 
                   placeholder="Label name..."
                   [(ngModel)]="newLabelName"
                   (keyup.enter)="createLabel()">
            
            <div class="inline-color-picker">
                <button *ngFor="let color of labelColors"
                        class="color-dot"
                        [class.selected]="newLabelColor === color.value"
                        [style.background]="color.value"
                        [title]="color.name"
                        (click)="newLabelColor = color.value">
                </button>
            </div>

            <div class="inline-actions">
                <button class="btn-cancel-inline" (click)="toggleInlineLabelCreate()">
                    Cancel
                </button>
                <button class="btn-create-inline" 
                        [disabled]="!newLabelName.trim()"
                        (click)="createLabel()">
                    <span class="material-symbols-outlined">add</span>
                    Create
                </button>
            </div>
        </div>

        <div class="modal-body">
            <input #titleInput 
                   type="text" 
                   class="modal-title-input" 
                   placeholder="Title" 
                   [(ngModel)]="formData.title">

            <!-- Text Note Content -->
            <textarea *ngIf="formData.note_type === 'text' || !formData.note_type"
                      class="modal-text-area" 
                      placeholder="Write something..." 
                      [(ngModel)]="formData.content">
            </textarea>

            <!-- Todo List Content -->
            <div *ngIf="formData.note_type === 'todo'" class="todo-list-editor">
                <div *ngFor="let item of formData.todo_items" class="todo-item-editor">
                    <input type="checkbox" 
                           [checked]="item.completed"
                           (change)="toggleTodoItem(item)"
                           class="todo-checkbox">
                    <span class="todo-text" [class.completed]="item.completed">
                        {{ item.text }}
                    </span>
                    <button class="btn-remove-todo" (click)="removeTodoItem(item.id)">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>

                <div class="todo-input-wrapper">
                    <input type="text" 
                           class="todo-input" 
                           placeholder="Add a task..."
                           [(ngModel)]="newTodoText"
                           (keyup.enter)="addTodoItem()">
                    <button class="btn-add-todo" (click)="addTodoItem()">
                        <span class="material-symbols-outlined">add</span>
                    </button>
                </div>
            </div>

            <!-- Image Preview (Icons with Count) -->
            <div *ngIf="(selectedFile || (formData.images && formData.images.length > 0))" class="images-summary">
                <span class="material-symbols-outlined">image</span>
                <span class="images-count">
                    {{ (selectedFile ? 1 : 0) + (formData.images?.length || 0) }} 
                    {{ (selectedFile ? 1 : 0) + (formData.images?.length || 0) === 1 ? 'image' : 'images' }}
                </span>
                <span *ngIf="selectedFile" class="new-image-badge">New</span>
            </div>
        </div>

        <div class="modal-footer">
            <div class="left-actions">
                <button class="btn-icon" title="Add Image" (click)="fileInputModal.click()">
                    <span class="material-symbols-outlined">image</span>
                </button>
                <input #fileInputModal 
                       type="file" 
                       style="display: none" 
                       (change)="onFileSelected($event)" 
                       accept="image/*">
            </div>
            <button class="btn btn-primary" (click)="saveNote()">Save</button>
        </div>
    </div>
</div>

<!-- Label Manager Modal -->
<div *ngIf="showLabelManagerModal" class="modal-overlay">
    <div class="modal-content small-modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <h2 class="modal-title">Manage Labels</h2>
            <button class="btn-close" (click)="closeLabelManager()">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>

        <div class="modal-body">
            <!-- Create New Label -->
            <div class="label-create-section">
                <input type="text" 
                       class="label-input" 
                       placeholder="Label name..."
                       [(ngModel)]="newLabelName"
                       (keyup.enter)="createLabel()">
                
                <div class="color-picker">
                    <button *ngFor="let color of labelColors"
                            class="color-option"
                            [class.selected]="newLabelColor === color.value"
                            [style.background]="color.value"
                            [title]="color.name"
                            (click)="newLabelColor = color.value">
                    </button>
                </div>

                <button class="btn btn-primary btn-small" 
                        [disabled]="!newLabelName.trim()"
                        (click)="createLabel()">
                    <span class="material-symbols-outlined">add</span>
                    Create Label
                </button>
            </div>

            <!-- Existing Labels -->
            <div class="labels-list">
                <div *ngFor="let label of labels" class="label-item">
                    <span class="label-color-dot" [style.background]="label.color || '#9c33ff'"></span>
                    <span class="label-name">{{ label.name }}</span>
                    <button class="btn-delete-label" (click)="deleteLabel(label.id)">
                        <span class="material-symbols-outlined">delete</span>
                    </button>
                </div>
                <div *ngIf="labels.length === 0" class="empty-labels">
                    No labels yet. Create one above!
                </div>
            </div>
        </div>
    </div>
</div>
